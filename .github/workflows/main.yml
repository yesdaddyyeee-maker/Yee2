name: WhatsApp Bot

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Get previous run ID
      id: get-run-id
      run: |
        RUN_ID=$(gh run list --workflow "WhatsApp Bot" --status success --json databaseId --jq '.[0].databaseId' 2>/dev/null || echo "")
        if [ -n "$RUN_ID" ]; then
          echo "run-id=$RUN_ID" >> "$GITHUB_OUTPUT"
          echo "✓ Found previous successful run: $RUN_ID"
        else
          echo "run-id=" >> "$GITHUB_OUTPUT"
          echo "⚠ No previous successful run found"
        fi
      env:
        GH_TOKEN: ${{ github.token }}
      continue-on-error: true

    - name: Restore WhatsApp session
      if: steps.get-run-id.outputs.run-id != ''
      uses: actions/download-artifact@v4
      with:
        name: wa-session
        path: auth_info/
        github-token: ${{ github.token }}
        run-id: ${{ steps.get-run-id.outputs.run-id }}
      continue-on-error: true
    
    - name: Check for credentials
      ...
    
    - name: Save WhatsApp session
      uses: actions/upload-artifact@v4
      ...
